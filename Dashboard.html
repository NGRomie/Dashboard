<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Engagement Dashboard - University of Arizona Think Tank</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* === EXISTING STYLES (keeping most of them) === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .dashboard-header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .dashboard-header p {
            color: #7f8c8d;
            font-size: 1.2em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1em;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .green { color: #27ae60; }
        .yellow { color: #f39c12; }
        .red { color: #e74c3c; }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.4em;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .student-list {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.8em;
            color: #2c3e50;
            margin-bottom: 25px;
            text-align: center;
        }

        .student-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .student-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .student-red { background: #fdf2f2; border-left: 5px solid #e74c3c; }
        .student-yellow { background: #fefcf0; border-left: 5px solid #f39c12; }
        .student-green { background: #f0f9f4; border-left: 5px solid #27ae60; }

        .student-status {
            font-size: 1.5em;
            margin-right: 15px;
            width: 30px;
        }

        .student-info {
            flex: 1;
        }

        .student-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .student-details {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .student-score {
            font-size: 1.5em;
            font-weight: bold;
            margin-left: 15px;
        }

        .filters {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-label {
            font-weight: bold;
            color: #2c3e50;
        }

        .filter-button {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .filter-active {
            background: #3498db;
            color: white;
        }

        .filter-inactive {
            background: #ecf0f1;
            color: #7f8c8d;
        }

        .filter-button:hover {
            transform: translateY(-2px);
        }

        .last-updated {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            margin-top: 20px;
        }

        /* Grid View Styles */
        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 18px;
        }

        .student-card {
            background: #f7f9fc;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.2s;
            text-align: center;
            border-left: 5px solid transparent;
        }

        .student-card.student-green { border-left-color: #27ae60; }
        .student-card.student-yellow { border-left-color: #f39c12; }
        .student-card.student-red { border-left-color: #e74c3c; }
        .student-card:hover {
            transform: translateY(-3px) scale(1.03);
        }

        /* Timeline Styles */
        #milestoneTimelineWrapper {
            background: #fff;
            border-radius: 15px;
            margin-bottom: 28px;
            box-shadow: 0 5px 18px rgba(0,0,0,0.08);
            padding: 16px 18px;
            overflow-x: auto;
            overflow-y: visible;
            height: 140px;
            position: relative;
        }

        .timeline-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            align-items: center;
        }

        .milestone-timeline {
            position: relative;
            min-width: 900px;
            height: 100%;
            box-sizing: border-box;
            background-image: repeating-linear-gradient(
                to right,
                transparent,
                transparent calc(100% / 16 - 1px),
                #ccc calc(100% / 16 - 1px),
                #ccc calc(100% / 16)
            );
            background-repeat: no-repeat;
            background-size: 100% 100%;
        }

        .timeline-track {
            position: absolute;
            left: 0; right: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 2px;
            background: rgba(12,35,75,0.92);
            border-radius: 1px;
            z-index: 0;
        }

        .timeline-band {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            height: 2px;
            border-radius: 1px;
            background: rgba(255,215,0,0.6);
            z-index: 1;
        }

        .timeline-dot {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 20px; height: 20px;
            border-radius: 50%;
            background: #AB0520;
            border: 2px solid #fff;
            box-shadow: 0 0 6px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            color: #fff;
            z-index: 2;
            cursor: pointer;
        }

        .timeline-dot .popover {
            display: none;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 100%;
            margin-bottom: 6px;
            background: #fff;
            color: #071C3B;
            padding: 6px 10px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            white-space: nowrap;
            z-index: 5;
            font-size: 0.9em;
        }

        .timeline-dot:hover .popover {
            display: block;
        }

        .timeline-month-shade {
            position: absolute;
            top: 0;
            bottom: 0;
            border-left: 1px solid rgba(0,0,0,0.1);
            border-right: 1px solid rgba(0,0,0,0.1);
            z-index: 0;
        }

        .timeline-current-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e74c3c;
            z-index: 3;
        }

        #milestoneTimelineWrapper::-webkit-scrollbar {
            height: 8px;
        }

        #milestoneTimelineWrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #milestoneTimelineWrapper::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        #milestoneTimelineWrapper::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Advanced Filter Styles */
        .advanced-filters {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9em;
            min-width: 120px;
        }

        /* Coach Notes Styles */
        .coach-note-summary {
            cursor: pointer;
            font-weight: bold;
            padding: 8px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }

        .coach-note-summary:hover {
            background-color: #f8f9fa;
        }

        .coach-note-details {
            color: #555;
            margin-left: 14px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
            margin-top: 5px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            width: 80%;
            max-width: 900px;
            margin: 50px auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .modal-close:hover {
            color: #333;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            background: #f8f9fa;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }

        @media (max-width: 768px) {
            .dashboard-header h1 {
                font-size: 2em;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .student-item {
                flex-direction: column;
                text-align: center;
            }

            .filters {
                flex-direction: column;
                align-items: stretch;
            }
        }

        @media print {
            body { background: white; }
            .no-print { display: none !important; }
            .page-break { page-break-after: always; }
        }

        /* === NEW FEATURE STYLES === */
        
        /* Alerts Panel */
        .alerts-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .alert-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .alert-item.critical {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .alert-icon {
            font-size: 1.5em;
            margin-right: 15px;
        }

        .alert-content {
            flex: 1;
        }

        .alert-dismiss {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            color: #999;
        }

        /* Predictive Analytics */
        .prediction-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 8px;
            background: #e3f2fd;
            color: #1976d2;
        }

        .prediction-badge.warning {
            background: #fff3e0;
            color: #f57c00;
        }

        /* Bulk Actions Bar */
        .bulk-actions-bar {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 15px 25px;
            border-radius: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 999;
        }

        .bulk-actions-bar.show {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Student Selection */
        .student-item.selectable {
            position: relative;
            padding-left: 50px;
        }

        .student-checkbox {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* Export/Import Panel */
        .data-management {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* Communication Log */
        .comm-log {
            max-height: 400px;
            overflow-y: auto;
        }

        .comm-entry {
            display: flex;
            align-items: start;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .comm-icon {
            width: 40px;
            height: 40px;
            background: #e3f2fd;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .comm-details {
            flex: 1;
        }

        .comm-timestamp {
            font-size: 0.85em;
            color: #999;
        }

        /* Goal Setting */
        .goal-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .goal-progress {
            width: 100px;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin: 0 10px;
            overflow: hidden;
        }

        .goal-progress-bar {
            height: 100%;
            background: #28a745;
            transition: width 0.3s ease;
        }

        /* Dashboard Customization */
        .customize-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .widget-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .widget-toggle input {
            width: 20px;
            height: 20px;
        }

        /* Student Comparison */
        .comparison-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .comparison-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .comparison-bar {
            flex: 1;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            margin: 0 15px;
            position: relative;
            overflow: hidden;
        }

        .comparison-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: #3498db;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .comparison-fill.student {
            background: #e74c3c;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <!-- Dashboard Customization Button -->
    <button class="customize-button no-print" onclick="DashboardCustomizer.toggle()">
        ⚙️ Customize Dashboard
    </button>

    <div class="dashboard-header">
        <h1>🎯 Student Engagement Dashboard</h1>
        <p>University of Arizona Think Tank • Proactive Student Support System</p>
    </div>

    <!-- NEW: Alerts Panel -->
    <div class="alerts-panel" id="alertsPanel" style="display: none;">
        <h3 style="margin-bottom: 15px;">📢 System Alerts</h3>
        <div id="alertsContainer"></div>
    </div>

    <!-- NEW: Data Management Panel -->
    <div class="data-management no-print">
        <span style="font-weight: bold;">Data Management:</span>
        <button class="filter-button filter-inactive" onclick="DataExport.exportToCSV()">📊 Export to CSV</button>
        <button class="filter-button filter-inactive" onclick="DataExport.exportToJSON()">📄 Export to JSON</button>
        <button class="filter-button filter-inactive" onclick="DataImport.showImportDialog()">📥 Import Data</button>
        <button class="filter-button filter-inactive" onclick="Reports.generateReport()">📑 Generate Report</button>
        <button class="filter-button filter-inactive" onclick="BulkActions.toggleSelectionMode()">☑️ Bulk Select</button>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number green" id="greenCount">0</div>
            <div class="stat-label">Doing Well</div>
        </div>
        <div class="stat-card">
            <div class="stat-number yellow" id="yellowCount">0</div>
            <div class="stat-label">Need Attention</div>
        </div>
        <div class="stat-card">
            <div class="stat-number red" id="redCount">0</div>
            <div class="stat-label">Immediate Action</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" style="color: #3498db;" id="totalCount">0</div>
            <div class="stat-label">Total Students</div>
        </div>
    </div>

    <!-- NEW: Student Comparison Panel -->
    <div class="comparison-panel" id="comparisonPanel" style="display: none;">
        <h3 style="margin-bottom: 20px;">📊 Student vs Class Average Comparison</h3>
        <div id="comparisonContent"></div>
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid">
        <div class="chart-container">
            <div class="chart-title">Student Status Distribution</div>
            <canvas id="statusChart"></canvas>
        </div>
        <div class="chart-container">
            <div class="chart-title">Grade Distribution</div>
            <canvas id="gradeChart"></canvas>
        </div>
        <div class="chart-container">
            <div class="chart-title">Survey Sentiment Analysis</div>
            <canvas id="sentimentChart"></canvas>
        </div>
        <div class="chart-container">
            <div class="chart-title">ALEKS Engagement vs Performance</div>
            <canvas id="aleksChart"></canvas>
        </div>
        <div class="chart-container">
            <div class="chart-title">Think Tank Utilization</div>
            <canvas id="thinkTankChart"></canvas>
        </div>
        <!-- NEW: Predictive Analytics Chart -->
        <div class="chart-container" id="predictiveChart" style="display: none;">
            <div class="chart-title">Risk Prediction - Next 2 Weeks</div>
            <canvas id="riskPredictionChart"></canvas>
        </div>
    </div>

    <!-- Student List -->
    <div class="student-list">
        <div class="section-title">Student Priority List</div>
        <div id="studentContainer"></div>
    </div>

    <!-- NEW: Bulk Actions Bar -->
    <div class="bulk-actions-bar" id="bulkActionsBar">
        <span id="selectedCount">0 students selected</span>
        <button class="filter-button filter-active" onclick="BulkActions.sendEmail()">📧 Send Email</button>
        <button class="filter-button filter-active" onclick="BulkActions.scheduleCheckin()">📅 Schedule Check-in</button>
        <button class="filter-button filter-active" onclick="BulkActions.assignGoals()">🎯 Assign Goals</button>
        <button class="filter-button filter-active" onclick="BulkActions.exportSelected()">📊 Export Selected</button>
        <button class="filter-button filter-inactive" onclick="BulkActions.clearSelection()">❌ Clear</button>
    </div>

    <!-- Existing Modals -->
    <div id="studentProfileModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="StudentProfile.close()">×</button>
            <div id="studentProfileContent"></div>
        </div>
    </div>

    <!-- Student Form Modal -->
    <div id="studentFormModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close" onclick="StudentForm.close()">×</button>
            <h2 id="studentFormTitle" style="margin-bottom: 20px;">Add Student</h2>
            <form id="studentForm" onsubmit="StudentForm.save(event)">
                <input type="hidden" id="formStudentId">
                
                <div class="form-group">
                    <label for="formFirstName">First Name:</label>
                    <input type="text" id="formFirstName" required>
                </div>
                
                <div class="form-group">
                    <label for="formLastName">Last Name:</label>
                    <input type="text" id="formLastName" required>
                </div>
                
                <div class="form-group">
                    <label for="formGrade">Grade (%):</label>
                    <input type="number" id="formGrade" min="0" max="100" required>
                </div>
                
                <div class="form-group">
                    <label for="formAleksDays">Days Since Last ALEKS Login:</label>
                    <input type="number" id="formAleksDays" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="formAleksTopics">ALEKS Topics Completed:</label>
                    <input type="number" id="formAleksTopics" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="formThinkTankVisits">Think Tank Visits This Month:</label>
                    <input type="number" id="formThinkTankVisits" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="formStress">Stress Level (1-10):</label>
                    <input type="number" id="formStress" min="1" max="10" required>
                </div>
                
                <div class="form-group">
                    <label for="formConfidence">Confidence Level (1-10):</label>
                    <input type="number" id="formConfidence" min="1" max="10" required>
                </div>
                
                <div class="form-group">
                    <label for="formWellness">Wellness Score (1-100):</label>
                    <input type="number" id="formWellness" min="1" max="100" required>
                </div>
                
                <button type="submit" class="filter-button filter-active" style="width:100%;margin-top:10px;">Save Student</button>
            </form>
        </div>
    </div>

    <div class="last-updated">
        Last updated: <span id="lastUpdated"></span>
    </div>

    <script>
        // === ENHANCED DASHBOARD CODE ===

        // === CORE DATA MANAGER ===
        const CONFIG = {
            SEMESTER_START: new Date('2025-06-02'),
            SEMESTER_END: new Date('2025-08-08'),
            CURRENT_DATE: new Date()
        };

        const SAMPLE_DATA = {
            firstNames: ['Emma', 'Liam', 'Olivia', 'Noah', 'Ava', 'Ethan', 'Sophia', 'Mason', 'Isabella', 'William',
                        'Mia', 'James', 'Charlotte', 'Benjamin', 'Amelia', 'Lucas', 'Harper', 'Henry', 'Evelyn', 'Alexander'],
            lastNames: ['Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez', 'Hernandez'],
            
            surveyQuotes: {
                stress: {
                    high: [
                        "I feel overwhelmed with everything I have to do",
                        "I'm having trouble sleeping because I worry about school",
                        "The workload feels impossible to manage",
                        "I panic when I think about upcoming exams",
                        "I can't focus because I'm so anxious all the time"
                    ],
                    medium: [
                        "Some days are harder than others to manage",
                        "I feel stressed but I'm trying to cope",
                        "School is challenging but I think I can handle it",
                        "The workload is manageable most of the time"
                    ],
                    low: [
                        "I feel pretty calm about school overall",
                        "I'm managing my stress well this semester",
                        "School feels challenging but not overwhelming",
                        "I have good strategies for dealing with pressure"
                    ]
                },
                confidence: {
                    high: [
                        "I believe I can succeed in my classes",
                        "I feel prepared for the challenges ahead",
                        "I trust my ability to learn new material",
                        "I'm confident I can achieve my academic goals"
                    ],
                    medium: [
                        "I think I can probably do well if I work hard",
                        "Some subjects feel easier than others for me",
                        "My confidence varies depending on the subject"
                    ],
                    low: [
                        "I don't think I'm smart enough for college",
                        "I worry I'm not cut out for this",
                        "Everyone else seems to understand things better than me",
                        "I doubt my ability to succeed academically"
                    ]
                }
            }
        };

        const DataManager = {
            students: [],
            charts: {},

            generateCoachNotes() {
                const topics = [
                    "Discussed exam strategy",
                    "Reviewed homework progress", 
                    "Talked about stress management",
                    "Set goals for ALEKS topics",
                    "Addressed attendance concerns",
                    "Career planning discussion",
                    "Study group formation",
                    "Time management strategies"
                ];
                const details = [
                    "Student expressed some anxiety but is willing to try campus resources.",
                    "Agreed to check in again before next major assignment.",
                    "Coach recommended regular Think Tank visits.",
                    "Student is confident about keeping up with coursework.",
                    "Planned to join a study group.",
                    "Discussed using campus tutoring services.",
                    "Student committed to daily ALEKS practice.",
                    "Explored stress reduction techniques together."
                ];
                
                const notes = [];
                const noteCount = 1 + Math.floor(Math.random() * 3);
                for (let i = 0; i < noteCount; i++) {
                    let daysAgo = Math.floor(Math.random() * 20);
                    let date = new Date();
                    date.setDate(date.getDate() - daysAgo);
                    notes.push({
                        date: date.toISOString(),
                        summary: topics[Math.floor(Math.random() * topics.length)],
                        details: details[Math.floor(Math.random() * details.length)]
                    });
                }
                notes.sort((a, b) => new Date(b.date) - new Date(a.date));
                return notes;
            },

            calculateComprehensiveSentiment(student) {
                let sentiment = 5; // Base neutral score
                
                // Academic performance impact (30% weight)
                if (student.grade >= 85) sentiment += 1.5;
                else if (student.grade >= 70) sentiment += 0.5;
                else if (student.grade < 60) sentiment -= 2;
                
                // Engagement impact (25% weight)
                if (student.aleksDays <= 2) sentiment += 1;
                else if (student.aleksDays <= 5) sentiment += 0.5;
                else sentiment -= 1.5;
                
                // Support utilization (20% weight)
                if (student.thinkTankVisits >= 3) sentiment += 1;
                else if (student.thinkTankVisits === 0) sentiment -= 1;
                
                // Stress/confidence impact (25% weight)
                sentiment += (student.confidence - student.stress) * 0.3;
                
                return Math.max(1, Math.min(10, Math.round(sentiment * 10) / 10));
            },

            generateAttendanceData(studentType) {
                const attendanceDates = [];
                const attendanceData = [];
                const today = new Date();
                
                for (let i = 0; i < 14; i++) {
                    const date = new Date();
                    date.setDate(today.getDate() - (13 - i));
                    attendanceDates.push(date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'}));
                    
                    // Attendance probability based on student type
                    const attendanceRate = studentType === 'struggling' ? 0.6 : 
                                         studentType === 'average' ? 0.8 : 0.95;
                    attendanceData.push(Math.random() < attendanceRate ? 1 : 0);
                }
                return { dates: attendanceDates, data: attendanceData };
            },

            generateAleksActivity(studentType) {
                const aleksDates = [];
                const aleksData = [];
                const today = new Date();
                
                for (let i = 0; i < 14; i++) {
                    const date = new Date();
                    date.setDate(today.getDate() - (13 - i));
                    aleksDates.push(date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'}));
                    
                    // Activity minutes based on student type
                    const baseMinutes = studentType === 'struggling' ? 5 : 
                                       studentType === 'average' ? 20 : 35;
                    const variation = Math.floor(Math.random() * 20);
                    aleksData.push(Math.max(0, baseMinutes + variation - 10));
                }
                return { dates: aleksDates, data: aleksData };
            },

            generateStudents() {
                const students = [];
                for (let i = 0; i < 50; i++) {
                    const firstName = SAMPLE_DATA.firstNames[Math.floor(Math.random() * SAMPLE_DATA.firstNames.length)];
                    const lastName = SAMPLE_DATA.lastNames[Math.floor(Math.random() * SAMPLE_DATA.lastNames.length)];
                    const studentType = Math.random() < 0.2 ? 'struggling' : Math.random() < 0.7 ? 'average' : 'excelling';
                    
                    let grade, aleksDays, aleksTopics, thinkTankVisits, stress, confidence, wellness;
                    
                    if (studentType === 'struggling') {
                        grade = 40 + Math.random() * 25;
                        aleksDays = 5 + Math.floor(Math.random() * 10);
                        aleksTopics = Math.floor(Math.random() * 15);
                        thinkTankVisits = Math.floor(Math.random() * 3);
                        stress = 7 + Math.floor(Math.random() * 4);
                        confidence = 1 + Math.floor(Math.random() * 4);
                        wellness = 20 + Math.random() * 40;
                    } else if (studentType === 'excelling') {
                        grade = 85 + Math.random() * 13;
                        aleksDays = Math.floor(Math.random() * 3);
                        aleksTopics = 25 + Math.floor(Math.random() * 15);
                        thinkTankVisits = 2 + Math.floor(Math.random() * 5);
                        stress = 1 + Math.floor(Math.random() * 5);
                        confidence = 7 + Math.floor(Math.random() * 4);
                        wellness = 80 + Math.random() * 20;
                    } else {
                        grade = 70 + Math.random() * 15;
                        aleksDays = 1 + Math.floor(Math.random() * 4);
                        aleksTopics = 15 + Math.floor(Math.random() * 10);
                        thinkTankVisits = 1 + Math.floor(Math.random() * 4);
                        stress = 3 + Math.floor(Math.random() * 5);
                        confidence = 5 + Math.floor(Math.random() * 4);
                        wellness = 60 + Math.random() * 20;
                    }

                    const status = wellness >= 80 ? 'green' : wellness >= 60 ? 'yellow' : 'red';
                    const statusEmoji = status === 'green' ? '🟢' : status === 'yellow' ? '🟡' : '🔴';
                    
                    const stressLevel = stress >= 8 ? 'high' : stress >= 5 ? 'medium' : 'low';
                    const confidenceLevel = confidence >= 8 ? 'high' : confidence >= 5 ? 'medium' : 'low';
                    
                    const stressQuote = SAMPLE_DATA.surveyQuotes.stress[stressLevel][Math.floor(Math.random() * SAMPLE_DATA.surveyQuotes.stress[stressLevel].length)];
                    const confidenceQuote = SAMPLE_DATA.surveyQuotes.confidence[confidenceLevel][Math.floor(Math.random() * SAMPLE_DATA.surveyQuotes.confidence[confidenceLevel].length)];

                    const student = {
                        id: `UA${1000 + i}`,
                        firstName,
                        lastName,
                        fullName: `${firstName} ${lastName}`,
                        grade: Math.round(grade * 10) / 10,
                        aleksDays: Math.floor(aleksDays),
                        aleksTopics: Math.floor(aleksTopics),
                        thinkTankVisits: Math.floor(thinkTankVisits),
                        stress: Math.floor(stress),
                        confidence: Math.floor(confidence),
                        wellness: Math.round(wellness * 10) / 10,
                        status,
                        statusEmoji,
                        type: studentType,
                        stressQuote,
                        confidenceQuote,
                        coachNotes: this.generateCoachNotes(),
                        attendanceData: this.generateAttendanceData(studentType),
                        aleksActivityData: this.generateAleksActivity(studentType)
                    };

                    // Calculate comprehensive sentiment score
                    student.sentimentScore = this.calculateComprehensiveSentiment(student);
                    
                    students.push(student);
                }
                
                this.students = students.sort((a, b) => a.wellness - b.wellness);
                return this.students;
            },

            getStudentById(id) {
                return this.students.find(s => s.id === id);
            },

            addStudent(studentData) {
                const newId = `UA${1000 + this.students.length + 1}`;
                const student = {
                    ...studentData,
                    id: newId,
                    fullName: `${studentData.firstName} ${studentData.lastName}`,
                    status: studentData.wellness >= 80 ? 'green' : studentData.wellness >= 60 ? 'yellow' : 'red',
                    statusEmoji: studentData.wellness >= 80 ? '🟢' : studentData.wellness >= 60 ? '🟡' : '🔴',
                    type: (studentData.wellness < 60 || studentData.grade < 70) ? 'struggling' : studentData.wellness > 85 ? 'excelling' : 'average',
                    coachNotes: this.generateCoachNotes(),
                    attendanceData: this.generateAttendanceData(studentData.wellness < 60 ? 'struggling' : studentData.wellness > 85 ? 'excelling' : 'average'),
                    aleksActivityData: this.generateAleksActivity(studentData.wellness < 60 ? 'struggling' : studentData.wellness > 85 ? 'excelling' : 'average')
                };
                
                // Calculate comprehensive sentiment score
                student.sentimentScore = this.calculateComprehensiveSentiment(student);
                
                this.students.push(student);
                return student;
            },

            updateStudent(id, studentData) {
                const index = this.students.findIndex(s => s.id === id);
                if (index > -1) {
                    const updatedStudent = {
                        ...this.students[index],
                        ...studentData,
                        fullName: `${studentData.firstName} ${studentData.lastName}`,
                        status: studentData.wellness >= 80 ? 'green' : studentData.wellness >= 60 ? 'yellow' : 'red',
                        statusEmoji: studentData.wellness >= 80 ? '🟢' : studentData.wellness >= 60 ? '🟡' : '🔴',
                        type: (studentData.wellness < 60 || studentData.grade < 70) ? 'struggling' : studentData.wellness > 85 ? 'excelling' : 'average'
                    };
                    
                    // Recalculate comprehensive sentiment score
                    updatedStudent.sentimentScore = this.calculateComprehensiveSentiment(updatedStudent);
                    
                    this.students[index] = updatedStudent;
                    return this.students[index];
                }
                return null;
            }
        };

        // === STATISTICS MANAGER ===
        const StatsManager = {
            update() {
                const green = DataManager.students.filter(s => s.status === 'green').length;
                const yellow = DataManager.students.filter(s => s.status === 'yellow').length;
                const red = DataManager.students.filter(s => s.status === 'red').length;
                
                document.getElementById('greenCount').textContent = green;
                document.getElementById('yellowCount').textContent = yellow;
                document.getElementById('redCount').textContent = red;
                document.getElementById('totalCount').textContent = DataManager.students.length;
            }
        };

        // === CHART MANAGER ===
        const ChartManager = {
            cleanup() {
                Object.values(DataManager.charts).forEach(chart => {
                    if (chart && typeof chart.destroy === 'function') {
                        chart.destroy();
                    }
                });
                DataManager.charts = {};
            },

            createAll() {
                this.cleanup();
                this.createStatusChart();
                this.createGradeChart();
                this.createSentimentChart();
                this.createAleksChart();
                this.createThinkTankChart();
            },

            createStatusChart() {
                const ctx = document.getElementById('statusChart').getContext('2d');
                DataManager.charts.status = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Doing Well', 'Need Attention', 'Immediate Action'],
                        datasets: [{
                            data: [
                                DataManager.students.filter(s => s.status === 'green').length,
                                DataManager.students.filter(s => s.status === 'yellow').length,
                                DataManager.students.filter(s => s.status === 'red').length
                            ],
                            backgroundColor: ['#27ae60', '#f39c12', '#e74c3c'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            },

            createGradeChart() {
                const ctx = document.getElementById('gradeChart').getContext('2d');
                const gradeBins = Array(10).fill(0);
                DataManager.students.forEach(s => {
                    const bin = Math.min(9, Math.floor(s.grade / 10));
                    gradeBins[bin]++;
                });

                DataManager.charts.grade = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['0-10', '10-20', '20-30', '30-40', '40-50', '50-60', '60-70', '70-80', '80-90', '90-100'],
                        datasets: [{
                            label: 'Number of Students',
                            data: gradeBins,
                            backgroundColor: '#3498db',
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            },

            createSentimentChart() {
                const ctx = document.getElementById('sentimentChart').getContext('2d');
                const sentimentBins = Array(10).fill(0);
                DataManager.students.forEach(s => {
                    const bin = Math.min(9, Math.floor(s.sentimentScore));
                    sentimentBins[bin]++;
                });

                DataManager.charts.sentiment = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['1-2', '2-3', '3-4', '4-5', '5-6', '6-7', '7-8', '8-9', '9-10', '10'],
                        datasets: [{
                            label: 'Number of Students',
                            data: sentimentBins,
                            backgroundColor: [
                                '#e74c3c', '#e67e22', '#f39c12', '#f1c40f', '#ffeb3b',
                                '#cddc39', '#8bc34a', '#4caf50', '#2ecc71', '#27ae60'
                            ],
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { title: { display: true, text: 'Sentiment Score (1=Very Negative, 10=Very Positive)' } },
                            y: { beginAtZero: true, title: { display: true, text: 'Number of Students' } }
                        }
                    }
                });
            },

            createAleksChart() {
                const ctx = document.getElementById('aleksChart').getContext('2d');
                DataManager.charts.aleks = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Students',
                            data: DataManager.students.map(s => ({
                                x: s.aleksDays,
                                y: s.aleksTopics
                            })),
                            backgroundColor: DataManager.students.map(s => 
                                s.status === 'green' ? '#27ae60' : s.status === 'yellow' ? '#f39c12' : '#e74c3c'
                            )
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { title: { display: true, text: 'Days Since Last ALEKS Login' } },
                            y: { title: { display: true, text: 'ALEKS Topics Completed' } }
                        }
                    }
                });
            },

            createThinkTankChart() {
                const ctx = document.getElementById('thinkTankChart').getContext('2d');
                const thinkTankData = {
                    'Doing Well': this.getAverageVisits('green'),
                    'Need Attention': this.getAverageVisits('yellow'),
                    'Immediate Action': this.getAverageVisits('red')
                };

                DataManager.charts.thinkTank = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(thinkTankData),
                        datasets: [{
                            label: 'Average Visits per Month',
                            data: Object.values(thinkTankData),
                            backgroundColor: ['#27ae60', '#f39c12', '#e74c3c'],
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Average Visits' } }
                        }
                    }
                });
            },

            getAverageVisits(status) {
                const students = DataManager.students.filter(s => s.status === status);
                if (students.length === 0) return 0;
                return students.reduce((sum, s) => sum + s.thinkTankVisits, 0) / students.length;
            }
        };

        // === STUDENT MANAGER ===
        const StudentManager = {
            currentFilter: 'all',
            currentView: 'list',
            currentSort: 'wellness', // Default to wellness sorting
            advancedFilters: {},
            filteredStudents: [],

            filter(status, buttonElement) {
                this.currentFilter = status;
                this.display();
                this.updateFilterButtons(buttonElement);
            },

            setSortOrder(sortType) {
                this.currentSort = sortType;
                this.display();
                this.updateSortButtons();
            },

            toggleView(view) {
                this.currentView = view;
                this.display();
                this.updateViewButtons();
            },

            applyAdvancedFilters(filters) {
                this.advancedFilters = filters;
                this.display();
            },

            clearAdvancedFilters() {
                this.advancedFilters = {};
                this.display();
            },

            getFilteredStudents() {
                let students = DataManager.students;
                
                // Apply status filter
                if (this.currentFilter !== 'all') {
                    students = students.filter(s => s.status === this.currentFilter);
                }
                
                // Apply advanced filters
                if (Object.keys(this.advancedFilters).length > 0) {
                    students = students.filter(s => AdvancedFilters.matchesFilters(s, this.advancedFilters));
                }

                // Apply sorting
                if (this.currentSort === 'alphabetical') {
                    students = students.sort((a, b) => a.fullName.localeCompare(b.fullName));
                } else {
                    // Default wellness sorting (low to high, prioritizing red status students)
                    students = students.sort((a, b) => a.wellness - b.wellness);
                }
                
                this.filteredStudents = students;
                return students;
            },

            getFilteredCount() {
                return this.getFilteredStudents().length;
            },

            display() {
                const container = document.getElementById('studentContainer');
                const filteredStudents = this.getFilteredStudents();

                if (this.currentView === 'list') {
                    container.innerHTML = filteredStudents.map(student => {
                        const concerns = this.getConcerns(student);
                        return `
                            <div class="student-item student-${student.status}" onclick="StudentProfile.show('${student.id}')">
                                <div class="student-status">${student.statusEmoji}</div>
                                <div class="student-info">
                                    <div class="student-name">${student.fullName}</div>
                                    <div class="student-details">
                                        ${concerns.length > 0 ? concerns.join(' • ') : 'All indicators positive'}
                                    </div>
                                </div>
                                <div class="student-score" style="color: ${this.getStatusColor(student.status)}">
                                    ${student.wellness}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = `
                        <div class="student-grid">
                            ${filteredStudents.map(student => `
                                <div class="student-card student-${student.status}" onclick="StudentProfile.show('${student.id}')">
                                    <div class="student-status" style="font-size:2em;">${student.statusEmoji}</div>
                                    <div class="student-name" style="margin: 8px 0 4px 0; font-weight:bold;">${student.fullName}</div>
                                    <div style="color:#7f8c8d; font-size:0.95em; margin-bottom:6px;">${student.grade}% • ${student.wellness}/100</div>
                                    <div class="student-score" style="font-size:1.3em; color:${this.getStatusColor(student.status)}">${student.type.charAt(0).toUpperCase() + student.type.slice(1)}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                // Update filter result count if advanced filters are active
                if (Object.keys(this.advancedFilters).length > 0) {
                    AdvancedFilters.updateResultCount();
                }
            },

            getConcerns(student) {
                const concerns = [];
                if (student.grade < 70) concerns.push(`Grade: ${student.grade}%`);
                if (student.aleksDays > 3) concerns.push(`${student.aleksDays} days since ALEKS`);
                if (student.stress > 7) concerns.push('High stress');
                if (student.confidence < 5) concerns.push('Low confidence');
                if (student.thinkTankVisits === 0) concerns.push('No Think Tank visits');
                return concerns;
            },

            getStatusColor(status) {
                return status === 'green' ? '#27ae60' : status === 'yellow' ? '#f39c12' : '#e74c3c';
            },

            updateFilterButtons(activeButton) {
                document.querySelectorAll('.filters .filter-button').forEach(btn => {
                    if (btn !== activeButton && !btn.id.includes('ViewBtn') && !btn.id.includes('sortBtn') && !btn.textContent.includes('Advanced')) {
                        btn.classList.remove('filter-active');
                        btn.classList.add('filter-inactive');
                    }
                });
                activeButton.classList.remove('filter-inactive');
                activeButton.classList.add('filter-active');
            },

            updateSortButtons() {
                const wellnessBtn = document.getElementById('sortWellnessBtn');
                const alphaBtn = document.getElementById('sortAlphaBtn');
                
                wellnessBtn.classList.remove('filter-active', 'filter-inactive');
                alphaBtn.classList.remove('filter-active', 'filter-inactive');
                
                if (this.currentSort === 'wellness') {
                    wellnessBtn.classList.add('filter-active');
                    alphaBtn.classList.add('filter-inactive');
                } else {
                    wellnessBtn.classList.add('filter-inactive');
                    alphaBtn.classList.add('filter-active');
                }
            },

            updateViewButtons() {
                const listBtn = document.getElementById('listViewBtn');
                const gridBtn = document.getElementById('gridViewBtn');
                
                listBtn.classList.remove('filter-active', 'filter-inactive');
                gridBtn.classList.remove('filter-active', 'filter-inactive');
                
                if (this.currentView === 'list') {
                    listBtn.classList.add('filter-active');
                    gridBtn.classList.add('filter-inactive');
                } else {
                    listBtn.classList.add('filter-inactive');
                    gridBtn.classList.add('filter-active');
                }
            }
        };

        // === STUDENT PROFILE MANAGER ===
        const StudentProfile = {
            show(studentId) {
                const student = DataManager.getStudentById(studentId);
                if (!student) {
                    console.error(`Student ${studentId} not found`);
                    return;
                }
                
                const content = `
                    ${this.generateBriefing(student)}
                    
                    <h2 style="color: #2c3e50; margin-bottom: 20px;">${student.fullName} - Detailed Profile</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px;">Academic Performance</h4>
                            <p><strong>Current Grade:</strong> ${student.grade}%</p>
                            <p><strong>ALEKS Topics:</strong> ${student.aleksTopics} completed</p>
                            <p><strong>Last ALEKS Login:</strong> ${student.aleksDays} days ago</p>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px;">Support Utilization</h4>
                            <p><strong>Think Tank Visits:</strong> ${student.thinkTankVisits} this month</p>
                            <p><strong>Overall Wellness:</strong> ${student.wellness}/100</p>
                            <p><strong>Status:</strong> <span style="color: ${StudentManager.getStatusColor(student.status)}">${student.statusEmoji} ${student.status.charAt(0).toUpperCase() + student.status.slice(1)}</span></p>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px;">Comprehensive Analysis</h4>
                            <p><strong>Sentiment Score:</strong> ${student.sentimentScore}/10</p>
                            <p><strong>Stress Level:</strong> ${student.stress}/10</p>
                            <p><strong>Confidence Level:</strong> ${student.confidence}/10</p>
                        </div>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">Coach's Notes</h3>
                        <ul style="list-style: none; padding: 0;">
                            ${this.renderCoachNotes(student.coachNotes)}
                        </ul>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                        <div>
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">Class Attendance (Last 2 Weeks)</h4>
                            <canvas id="attendanceChart" style="max-height: 200px;"></canvas>
                        </div>
                        <div>
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">ALEKS Activity (Minutes/Day)</h4>
                            <canvas id="aleksActivityChart" style="max-height: 200px;"></canvas>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div>
                            <h4 style="color: #2c3e50; margin-bottom: 15px;">Recent Survey Responses</h4>
                            <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                                <h5 style="color: #856404; margin-bottom: 8px;">About Stress (${student.stress}/10):</h5>
                                <p style="font-style: italic; color: #6c757d; margin: 0;">"${student.stressQuote}"</p>
                            </div>
                            <div style="background: #d1ecf1; padding: 15px; border-radius: 10px; border-left: 4px solid #17a2b8;">
                                <h5 style="color: #0c5460; margin-bottom: 8px;">About Confidence (${student.confidence}/10):</h5>
                                <p style="font-style: italic; color: #6c757d; margin: 0;">"${student.confidenceQuote}"</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="StudentForm.open('${student.id}')" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Edit Student</button>
                        <button onclick="StudentProfile.logOutreach('${student.id}')" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Log New Contact</button>
                        <button onclick="StudentProfile.close()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Close</button>
                    </div>
                `;
                
                document.getElementById('studentProfileContent').innerHTML = content;
                document.getElementById('studentProfileModal').style.display = 'block';
                
                // Create charts after DOM is updated
                setTimeout(() => {
                    this.createAttendanceChart(student);
                    this.createAleksActivityChart(student);
                }, 100);
            },

            generateBriefing(student) {
                let statusText = "";
                if (student.grade >= 85) statusText = "excelling academically";
                else if (student.grade >= 70) statusText = "maintaining a satisfactory grade";
                else statusText = "currently struggling with coursework";

                let engagementText = student.aleksDays <= 3 ?
                    "They have engaged with ALEKS recently." :
                    `It has been ${student.aleksDays} days since their last ALEKS login.`;

                let stressText = student.stress > 7 ? "Recent surveys show high stress." : "";
                let confidenceText = student.confidence < 5 ? "Confidence is currently low." : "";

                let coachNoteText = "";
                if (student.coachNotes && student.coachNotes.length) {
                    let lastNote = student.coachNotes[0]; // Most recent (sorted desc)
                    coachNoteText = `In the last meeting (${new Date(lastNote.date).toLocaleDateString()}), the coach noted: "${lastNote.summary}".`;
                }

                let recommendation = "Recommendation: ";
                if (student.status === "red") recommendation += "Prioritize outreach and offer extra support resources.";
                else if (student.status === "yellow") recommendation += "Encourage continued engagement and monitor closely.";
                else recommendation += "Maintain current strategies and reinforce positive behaviors.";

                return `
                    <div style="background:#f8f9fa; border-left:4px solid #3498db; border-radius:8px; padding:12px 16px; margin-bottom:16px;">
                        <strong>Briefing for Coach:</strong><br>
                        ${student.fullName} is ${statusText} (grade: ${student.grade}%). ${engagementText}
                        ${stressText} ${confidenceText}
                        ${coachNoteText}
                        <br><em>${recommendation}</em>
                    </div>
                `;
            },

            renderCoachNotes(notes) {
                if (!notes || !notes.length) {
                    return '<li style="color: #7f8c8d; font-style: italic;">No coach notes on record.</li>';
                }

                return notes.map((note, i) => `
                    <li style="margin-bottom: 12px;">
                        <div class="coach-note-summary" onclick="StudentProfile.toggleCoachNote(${i})">
                            📝 <span>${new Date(note.date).toLocaleDateString('en-US', { 
                                month: 'short', 
                                day: 'numeric', 
                                year: 'numeric'
                            })} at ${new Date(note.date).toLocaleTimeString('en-US', {
                                hour: 'numeric',
                                minute: '2-digit',
                                hour12: true
                            })}</span>: ${note.summary}
                            <span id="expandIcon${i}" style="color:#3498db; margin-left: 8px;">[-]</span>
                        </div>
                        <div class="coach-note-details" id="coachNoteDetails${i}">
                            ${note.details}
                        </div>
                    </li>
                `).join('');
            },

            toggleCoachNote(index) {
                const details = document.getElementById(`coachNoteDetails${index}`);
                const icon = document.getElementById(`expandIcon${index}`);
                
                if (details.style.display === 'none') {
                    details.style.display = 'block';
                    icon.textContent = '[-]';
                } else {
                    details.style.display = 'none';
                    icon.textContent = '[+]';
                }
            },

            createAttendanceChart(student) {
                const ctx = document.getElementById('attendanceChart');
                if (!ctx) return;

                new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: student.attendanceData.dates,
                        datasets: [{
                            label: 'Attended',
                            data: student.attendanceData.data,
                            backgroundColor: student.attendanceData.data.map(val => val === 1 ? '#27ae60' : '#e74c3c'),
                            borderRadius: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 1,
                                ticks: {
                                    callback: function(value) {
                                        return value === 1 ? 'Present' : 'Absent';
                                    }
                                }
                            }
                        }
                    }
                });
            },

            createAleksActivityChart(student) {
                const ctx = document.getElementById('aleksActivityChart');
                if (!ctx) return;

                new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: student.aleksActivityData.dates,
                        datasets: [{
                            label: 'Minutes',
                            data: student.aleksActivityData.data,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Minutes' }
                            }
                        }
                    }
                });
            },

            logOutreach(studentId) {
                const student = DataManager.getStudentById(studentId);
                if (!student) return;
                
                const contactType = prompt('Contact type (Email/Text/Phone Call/In-person Meeting):');
                const notes = prompt('Notes about the contact:');
                
                if (contactType && notes) {
                    // Add new note to the beginning of array (most recent first)
                    student.coachNotes.unshift({
                        date: new Date().toISOString(),
                        summary: contactType,
                        details: notes
                    });
                    
                    alert(`Outreach logged for ${student.fullName}:\nType: ${contactType}\nNotes: ${notes}`);
                    
                    // Refresh the profile view
                    this.show(studentId);
                }
            },

            close() {
                document.getElementById('studentProfileModal').style.display = 'none';
            }
        };

        // === STUDENT FORM MANAGER ===
        const StudentForm = {
            open(studentId = null) {
                const form = document.getElementById('studentForm');
                const title = document.getElementById('studentFormTitle');
                form.reset();

                if (studentId) {
                    const student = DataManager.getStudentById(studentId);
                    if (!student) return;
                    
                    title.textContent = "Edit Student";
                    document.getElementById('formStudentId').value = student.id;
                    document.getElementById('formFirstName').value = student.firstName;
                    document.getElementById('formLastName').value = student.lastName;
                    document.getElementById('formGrade').value = student.grade;
                    document.getElementById('formAleksDays').value = student.aleksDays;
                    document.getElementById('formAleksTopics').value = student.aleksTopics;
                    document.getElementById('formThinkTankVisits').value = student.thinkTankVisits;
                    document.getElementById('formStress').value = student.stress;
                    document.getElementById('formConfidence').value = student.confidence;
                    document.getElementById('formWellness').value = student.wellness;
                } else {
                    title.textContent = "Add Student";
                    document.getElementById('formStudentId').value = '';
                }

                document.getElementById('studentFormModal').style.display = 'block';
            },

            close() {
                document.getElementById('studentFormModal').style.display = 'none';
            },

            save(event) {
                event.preventDefault();
                
                const studentData = {
                    firstName: document.getElementById('formFirstName').value,
                    lastName: document.getElementById('formLastName').value,
                    grade: Number(document.getElementById('formGrade').value),
                    aleksDays: Number(document.getElementById('formAleksDays').value),
                    aleksTopics: Number(document.getElementById('formAleksTopics').value),
                    thinkTankVisits: Number(document.getElementById('formThinkTankVisits').value),
                    stress: Number(document.getElementById('formStress').value),
                    confidence: Number(document.getElementById('formConfidence').value),
                    wellness: Number(document.getElementById('formWellness').value)
                };

                const id = document.getElementById('formStudentId').value;
                
                if (id) {
                    DataManager.updateStudent(id, studentData);
                } else {
                    DataManager.addStudent(studentData);
                }

                this.close();
                Dashboard.refresh();
            }
        };

        // === TIMELINE MANAGER ===
        const Timeline = {
            events: [
                { date: "2025-06-02", label: "Summer Session Starts", type: "registration" },
                { date: "2025-06-06", label: "Last Day to Add/Drop", type: "registration" },
                { date: "2025-06-09", label: "First Week Check-in", type: "outreach" },
                { date: "2025-06-16", label: "Early Outreach Week", type: "outreach" },
                { date: "2025-06-20", label: "Summer Solstice", type: "holiday" },
                { date: "2025-06-23", label: "Grade Reports Due", type: "exam" },
                { date: "2025-06-30", label: "Mid-Month Assessment", type: "exam" },
                { date: "2025-07-04", label: "Independence Day", type: "holiday" },
                { date: "2025-07-07", label: "Week 5 Progress Review", type: "outreach" },
                { date: "2025-07-14", label: "Midterm Period", type: "exam" },
                { date: "2025-07-18", label: "Midterm Grades Due", type: "exam" },
                { date: "2025-07-21", label: "Mid-Summer Check-in", type: "outreach" },
                { date: "2025-07-25", label: "Last Day to Withdraw", type: "registration" },
                { date: "2025-07-28", label: "Week 8 Intensive Support", type: "outreach" },
                { date: "2025-08-01", label: "Final Month Begins", type: "registration" },
                { date: "2025-08-04", label: "Finals Week", type: "exam" },
                { date: "2025-08-08", label: "Summer Session Ends", type: "exam" },
                { date: "2025-08-11", label: "Grade Submission Deadline", type: "exam" }
            ],
            currentFilter: 'all',

            init() {
                this.setupScrolling();
                this.render();
            },

            formatEventDate(dateStr) {
                const date = new Date(dateStr);
                const monthNames = ["January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"];
                const day = date.getDate();
                const suffix = this.getOrdinalSuffix(day);
                return `${monthNames[date.getMonth()]} ${day}${suffix}, ${date.getFullYear()}`;
            },

            formatTodayDate() {
                const today = new Date();
                const monthNames = ["January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"];
                const day = today.getDate();
                const month = today.getMonth();
                const year = today.getFullYear();
                return `Today, ${month + 1}/${day}/${year}`;
            },

            getOrdinalSuffix(day) {
                if (day > 3 && day < 21) return 'th';
                switch (day % 10) {
                    case 1: return 'st';
                    case 2: return 'nd';
                    case 3: return 'rd';
                    default: return 'th';
                }
            },

            filter(type, buttonElement) {
                this.currentFilter = type;
                this.render();
                this.updateFilterButtons(buttonElement);
            },

            handleEventClick(eventData) {
                const eventDetails = `
                    📅 ${eventData.label}
                    📆 ${this.formatEventDate(eventData.date)}
                    🏷️ Type: ${eventData.type.charAt(0).toUpperCase() + eventData.type.slice(1)}
                    
                    Would you like to:
                    • Add a reminder
                    • Edit this event
                    • Delete this event
                `;
                
                if (confirm(eventDetails + "\n\nClick OK to edit, Cancel to close")) {
                    this.editEvent(eventData);
                }
            },

            editEvent(eventData) {
                const newLabel = prompt('Edit event name:', eventData.label);
                const newDate = prompt('Edit date (YYYY-MM-DD):', eventData.date);
                
                if (newLabel && newDate) {
                    eventData.label = newLabel;
                    eventData.date = newDate;
                    this.render();
                }
            },

            render() {
                const container = document.getElementById('milestoneTimeline');
                container.innerHTML = '';

                // Calculate timeline dimensions
                const semesterLength = (CONFIG.SEMESTER_END - CONFIG.SEMESTER_START) / (1000 * 60 * 60 * 24);
                const weeks = semesterLength / 7;
                const pxPerWeek = 120; // Increased for better spacing
                container.style.width = Math.max(weeks * pxPerWeek, 1200) + 'px';

                // Add month background shading with borders
                this.addMonthShading(container);

                // Add main track
                const track = document.createElement('div');
                track.className = 'timeline-track';
                container.appendChild(track);

                // Add current date indicator with label
                const currentPercent = this.getTimelinePercent(CONFIG.CURRENT_DATE) * 100;
                if (currentPercent >= 0 && currentPercent <= 100) {
                    const currentLine = document.createElement('div');
                    currentLine.className = 'timeline-current-line';
                    currentLine.style.left = currentPercent + '%';
                    container.appendChild(currentLine);

                    // Add today marker label
                    const todayMarker = document.createElement('div');
                    todayMarker.className = 'timeline-today-marker';
                    todayMarker.style.left = currentPercent + '%';
                    todayMarker.textContent = this.formatTodayDate();
                    container.appendChild(todayMarker);
                }

                // Add event dots
                this.events.forEach(eventData => {
                    if (this.currentFilter !== 'all' && this.currentFilter !== eventData.type) return;
                    
                    const percent = this.getTimelinePercent(new Date(eventData.date)) * 100;
                    if (percent < 0 || percent > 100) return; // Skip events outside timeline
                    
                    const dot = document.createElement('div');
                    dot.className = 'timeline-dot';
                    dot.style.left = percent + '%';
                    dot.textContent = this.getEventEmoji(eventData.type);
                    dot.style.cursor = 'pointer';
                    
                    // Add click handler - capture eventData in closure
                    dot.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.handleEventClick(eventData);
                    });
                    
                    const popover = document.createElement('div');
                    popover.className = 'popover';
                    popover.textContent = `${eventData.label} (${this.formatEventDate(eventData.date)})`;
                    dot.appendChild(popover);
                    
                    container.appendChild(dot);
                });
            },

            addMonthShading(container) {
                const months = [
                    { name: 'June', start: new Date('2025-06-01'), color: 'rgba(227, 242, 253, 0.5)' },
                    { name: 'July', start: new Date('2025-07-01'), color: 'rgba(243, 229, 245, 0.5)' }, 
                    { name: 'August', start: new Date('2025-08-01'), color: 'rgba(232, 245, 232, 0.5)' }
                ];

                months.forEach((month, index) => {
                    const monthStart = this.getTimelinePercent(month.start) * 100;
                    const nextMonth = new Date(month.start);
                    nextMonth.setMonth(nextMonth.getMonth() + 1);
                    const monthEnd = this.getTimelinePercent(nextMonth) * 100;
                    
                    if (monthStart < 100 && monthEnd > 0) {
                        const shade = document.createElement('div');
                        shade.className = 'timeline-month-shade';
                        shade.style.cssText = `
                            left: ${Math.max(0, monthStart)}%;
                            width: ${Math.min(100, monthEnd) - Math.max(0, monthStart)}%;
                            background-color: ${month.color};
                        `;
                        container.appendChild(shade);

                        const label = document.createElement('div');
                        label.style.cssText = `
                            position: absolute;
                            top: 5px;
                            left: ${Math.max(0, monthStart + ((Math.min(100, monthEnd) - Math.max(0, monthStart)) / 2))}%;
                            transform: translateX(-50%);
                            font-size: 0.9em;
                            color: #555;
                            z-index: 2;
                        `;
                        label.textContent = month.name;
                        container.appendChild(label);
                    }
                });
            },

            getEventEmoji(type) {
                switch(type) {
                    case 'registration': return '📅';
                    case 'exam': return '📝';
                    case 'holiday': return '🎉';
                    case 'outreach': return '📞';
                    case 'custom': return '⭐';
                    default: return '•';
                }
            },

            getTimelinePercent(date) {
                const total = CONFIG.SEMESTER_END - CONFIG.SEMESTER_START;
                const offset = date - CONFIG.SEMESTER_START;
                return offset / total;
            },

            setupScrolling() {
                const wrapper = document.getElementById('milestoneTimelineWrapper');
                wrapper.scrollLeft = (wrapper.scrollWidth - wrapper.clientWidth) / 2;
            },

            updateFilterButtons(activeButton) {
                const buttons = document.querySelectorAll('.timeline-controls .filter-button');
                buttons.forEach(btn => {
                    btn.classList.remove('filter-active');
                    btn.classList.add('filter-inactive');
                });
                activeButton.classList.remove('filter-inactive');
                activeButton.classList.add('filter-active');
            }
        };

        // === ADVANCED FILTERS ===
        const AdvancedFilters = {
            matchesFilters(student, filters) {
                if (filters.name && !student.fullName.toLowerCase().includes(filters.name.toLowerCase())) {
                    return false;
                }
                if (filters.minGrade !== undefined && student.grade < filters.minGrade) {
                    return false;
                }
                if (filters.maxGrade !== undefined && student.grade > filters.maxGrade) {
                    return false;
                }
                if (filters.aleksDays) {
                    const [low, high] = filters.aleksDays.split('-').map(Number);
                    if (high !== undefined) {
                        if (!(student.aleksDays >= low && student.aleksDays <= high)) return false;
                    } else if (filters.aleksDays === '8+') {
                        if (student.aleksDays < 8) return false;
                    }
                }
                if (filters.visits) {
                    const [lowV, highV] = filters.visits.split('-').map(Number);
                    if (highV !== undefined) {
                        if (!(student.thinkTankVisits >= lowV && student.thinkTankVisits <= highV)) return false;
                    } else if (filters.visits === '3+') {
                        if (student.thinkTankVisits < 3) return false;
                    }
                }
                if (filters.stress) {
                    if (filters.stress === 'high' && student.stress < 8) return false;
                    if (filters.stress === 'medium' && (student.stress < 5 || student.stress > 7)) return false;
                    if (filters.stress === 'low' && student.stress > 4) return false;
                }
                return true;
            },

            applyFilters() {
                const name = document.getElementById('nameFilter').value;
                const minGrade = Number(document.getElementById('minGrade').value) || undefined;
                const maxGrade = Number(document.getElementById('maxGrade').value) || undefined;
                const aleksDays = document.getElementById('aleksDaysFilter').value;
                const visits = document.getElementById('visitsFilter').value;
                const stress = document.getElementById('stressFilter').value;

                const filters = {};
                if (name) filters.name = name;
                if (minGrade !== undefined) filters.minGrade = minGrade;
                if (maxGrade !== undefined) filters.maxGrade = maxGrade;
                if (aleksDays) filters.aleksDays = aleksDays;
                if (visits) filters.visits = visits;
                if (stress) filters.stress = stress;

                StudentManager.applyAdvancedFilters(filters);
                this.updateResultCount();
            },

            clearAll() {
                document.getElementById('nameFilter').value = '';
                document.getElementById('minGrade').value = '';
                document.getElementById('maxGrade').value = '';
                document.getElementById('aleksDaysFilter').value = '';
                document.getElementById('visitsFilter').value = '';
                document.getElementById('stressFilter').value = '';
                StudentManager.clearAdvancedFilters();
                document.getElementById('filterResultCount').textContent = '';
            },

            updateResultCount() {
                const count = StudentManager.getFilteredCount();
                const el = document.getElementById('filterResultCount');
                el.textContent = `${count} result${count !== 1 ? 's' : ''}`;
            }
        };

        // === CORE DASHBOARD CONTROLS ===
        const Dashboard = {
            init() {
                DataManager.generateStudents();
                StatsManager.update();
                ChartManager.createAll();
                StudentManager.display();
                Timeline.init();
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
            },

            refresh() {
                StatsManager.update();
                ChartManager.createAll();
                StudentManager.display();
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
            }
        };

        // === NEW FEATURE: PREDICTIVE ANALYTICS ===
        const PredictiveAnalytics = {
            calculateRiskScore(student) {
                let riskScore = 0;
                
                // Factors that increase risk
                if (student.grade < 70) riskScore += 25;
                else if (student.grade < 80) riskScore += 15;
                
                if (student.aleksDays > 7) riskScore += 20;
                else if (student.aleksDays > 3) riskScore += 10;
                
                if (student.thinkTankVisits === 0) riskScore += 15;
                
                if (student.stress > 7) riskScore += 20;
                if (student.confidence < 4) riskScore += 20;
                
                // Trend analysis
                if (student.attendanceData) {
                    const recentAttendance = student.attendanceData.data.slice(-5);
                    const absences = recentAttendance.filter(a => a === 0).length;
                    if (absences >= 3) riskScore += 15;
                }
                
                return Math.min(100, riskScore);
            },

            predictStatusChange(student) {
                const riskScore = this.calculateRiskScore(student);
                
                if (student.status === 'green' && riskScore > 60) {
                    return { prediction: 'yellow', confidence: riskScore };
                } else if (student.status === 'yellow' && riskScore > 80) {
                    return { prediction: 'red', confidence: riskScore };
                } else if (student.status === 'yellow' && riskScore < 30) {
                    return { prediction: 'green', confidence: 100 - riskScore };
                }
                
                return null;
            },

            createPredictiveChart() {
                const ctx = document.getElementById('riskPredictionChart');
                if (!ctx) return;

                const predictions = {
                    'Likely to Improve': 0,
                    'Stable': 0,
                    'At Risk - Yellow': 0,
                    'At Risk - Red': 0
                };

                DataManager.students.forEach(student => {
                    const prediction = this.predictStatusChange(student);
                    if (!prediction) {
                        predictions['Stable']++;
                    } else if (prediction.prediction === 'green') {
                        predictions['Likely to Improve']++;
                    } else if (prediction.prediction === 'yellow') {
                        predictions['At Risk - Yellow']++;
                    } else if (prediction.prediction === 'red') {
                        predictions['At Risk - Red']++;
                    }
                });

                new Chart(ctx.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: Object.keys(predictions),
                        datasets: [{
                            data: Object.values(predictions),
                            backgroundColor: ['#27ae60', '#3498db', '#f39c12', '#e74c3c']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }
        };

        // === NEW FEATURE: ALERTS SYSTEM ===
        const AlertsSystem = {
            alerts: [],
            
            checkAlerts() {
                this.alerts = [];
                
                DataManager.students.forEach(student => {
                    // Critical alerts
                    if (student.aleksDays > 10) {
                        this.alerts.push({
                            type: 'critical',
                            icon: '🚨',
                            message: `${student.fullName} hasn't logged into ALEKS for ${student.aleksDays} days`,
                            studentId: student.id
                        });
                    }
                    
                    if (student.grade < 60 && student.thinkTankVisits === 0) {
                        this.alerts.push({
                            type: 'critical',
                            icon: '⚠️',
                            message: `${student.fullName} is failing (${student.grade}%) and hasn't visited Think Tank`,
                            studentId: student.id
                        });
                    }
                    
                    // Warning alerts
                    const prediction = PredictiveAnalytics.predictStatusChange(student);
                    if (prediction && prediction.confidence > 70) {
                        this.alerts.push({
                            type: 'warning',
                            icon: '📉',
                            message: `${student.fullName} is predicted to move to ${prediction.prediction} status (${prediction.confidence}% confidence)`,
                            studentId: student.id
                        });
                    }
                });
                
                this.displayAlerts();
            },
            
            displayAlerts() {
                const container = document.getElementById('alertsContainer');
                const panel = document.getElementById('alertsPanel');
                
                if (this.alerts.length === 0) {
                    panel.style.display = 'none';
                    return;
                }
                
                panel.style.display = 'block';
                container.innerHTML = this.alerts.slice(0, 5).map((alert, index) => `
                    <div class="alert-item ${alert.type}">
                        <div class="alert-icon">${alert.icon}</div>
                        <div class="alert-content">
                            ${alert.message}
                            <button onclick="StudentProfile.show('${alert.studentId}')" style="margin-left: 10px; text-decoration: underline; background: none; border: none; cursor: pointer; color: #007bff;">View Profile</button>
                        </div>
                        <button class="alert-dismiss" onclick="AlertsSystem.dismissAlert(${index})">×</button>
                    </div>
                `).join('');
            },
            
            dismissAlert(index) {
                this.alerts.splice(index, 1);  
                this.displayAlerts();
            }
        };

        // === NEW FEATURE: BULK ACTIONS ===
        const BulkActions = {
            selectionMode: false,
            selectedStudents: new Set(),
            
            toggleSelectionMode() {
                this.selectionMode = !this.selectionMode;
                StudentManager.display();
                
                if (!this.selectionMode) {
                    this.clearSelection();
                }
            },
            
            toggleStudentSelection(studentId) {
                if (this.selectedStudents.has(studentId)) {
                    this.selectedStudents.delete(studentId);
                } else {
                    this.selectedStudents.add(studentId);
                }
                this.updateBulkActionsBar();
            },
            
            updateBulkActionsBar() {
                const bar = document.getElementById('bulkActionsBar');
                const count = document.getElementById('selectedCount');
                
                if (this.selectedStudents.size > 0) {
                    bar.classList.add('show');
                    count.textContent = `${this.selectedStudents.size} students selected`;
                } else {
                    bar.classList.remove('show');
                }
            },
            
            clearSelection() {
                this.selectedStudents.clear();
                this.updateBulkActionsBar();
                StudentManager.display();
            },
            
            sendEmail() {
                const students = Array.from(this.selectedStudents).map(id => DataManager.getStudentById(id));
                const emails = students.map(s => `${s.firstName.toLowerCase()}.${s.lastName.toLowerCase()}@email.arizona.edu`).join(', ');
                
                alert(`Opening email client for:\n${emails}\n\nSubject: Think Tank Check-in`);
                // In real implementation, would integrate with email service
            },
            
            scheduleCheckin() {
                const date = prompt('Schedule check-in for date (YYYY-MM-DD):');
                if (date) {
                    alert(`Check-in scheduled for ${this.selectedStudents.size} students on ${date}`);
                    // Would integrate with calendar system
                }
            },
            
            assignGoals() {
                const goal = prompt('Enter goal for selected students:');
                if (goal) {
                    this.selectedStudents.forEach(studentId => {
                        const student = DataManager.getStudentById(studentId);
                        if (student) {
                            student.goals = student.goals || [];
                            student.goals.push({
                                text: goal,
                                progress: 0,
                                dateAssigned: new Date().toISOString()
                            });
                        }
                    });
                    alert(`Goal assigned to ${this.selectedStudents.size} students`);
                    this.clearSelection();
                }
            },
            
            exportSelected() {
                const students = Array.from(this.selectedStudents).map(id => DataManager.getStudentById(id));
                DataExport.exportStudentsToCSV(students, 'selected_students');
            }
        };

        // === NEW FEATURE: DATA EXPORT/IMPORT ===
        const DataExport = {
            exportToCSV() {
                const csv = this.convertToCSV(DataManager.students);
                this.downloadFile(csv, 'students_export.csv', 'text/csv');
            },
            
            exportToJSON() {
                const json = JSON.stringify(DataManager.students, null, 2);
                this.downloadFile(json, 'students_export.json', 'application/json');
            },
            
            exportStudentsToCSV(students, filename = 'students') {
                const csv = this.convertToCSV(students);
                this.downloadFile(csv, `${filename}.csv`, 'text/csv');
            },
            
            convertToCSV(students) {
                const headers = ['ID', 'Name', 'Grade', 'ALEKS Days', 'ALEKS Topics', 'Think Tank Visits', 'Stress', 'Confidence', 'Wellness', 'Status'];
                const rows = students.map(s => [
                    s.id,
                    s.fullName,
                    s.grade,
                    s.aleksDays,
                    s.aleksTopics,
                    s.thinkTankVisits,
                    s.stress,
                    s.confidence,
                    s.wellness,
                    s.status
                ]);
                
                return [headers, ...rows].map(row => row.join(',')).join('\n');
            },
            
            downloadFile(content, filename, type) {
                const blob = new Blob([content], { type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;  
                a.click();
                URL.revokeObjectURL(url);
            }
        };

        const DataImport = {
            showImportDialog() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.csv,.json';
                input.onchange = (e) => this.handleFileImport(e.target.files[0]);
                input.click();
            },
            
            handleFileImport(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        if (file.name.endsWith('.json')) {
                            const data = JSON.parse(e.target.result);
                            this.importStudents(data);
                        } else if (file.name.endsWith('.csv')) {
                            this.importFromCSV(e.target.result);
                        }
                    } catch (error) {
                        alert('Error importing file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            },
            
            importStudents(students) {
                // Validate and merge with existing data
                const imported = students.filter(s => s.firstName && s.lastName && s.grade !== undefined);
                imported.forEach(s => {
                    DataManager.addStudent({
                        firstName: s.firstName,
                        lastName: s.lastName,
                        grade: s.grade,
                        aleksDays: s.aleksDays || 0,
                        aleksTopics: s.aleksTopics || 0,
                        thinkTankVisits: s.thinkTankVisits || 0,
                        stress: s.stress || 5,
                        confidence: s.confidence || 5,
                        wellness: s.wellness || 50
                    });
                });
                Dashboard.refresh();
                alert(`Successfully imported ${imported.length} students`);
            },
            
            importFromCSV(csvContent) {
                // Simple CSV parser
                const lines = csvContent.split('\n');
                const headers = lines[0].split(',');
                const students = [];
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split(',');
                        const student = {
                            firstName: values[1]?.split(' ')[0] || '',
                            lastName: values[1]?.split(' ')[1] || '',
                            grade: Number(values[2]) || 0,
                            aleksDays: Number(values[3]) || 0,
                            aleksTopics: Number(values[4]) || 0,
                            thinkTankVisits: Number(values[5]) || 0,
                            stress: Number(values[6]) || 5,
                            confidence: Number(values[7]) || 5,
                            wellness: Number(values[8]) || 50
                        };
                        students.push(student);
                    }
                }
                
                this.importStudents(students);
            }
        };

        // === NEW FEATURE: STUDENT COMPARISON ===
        const StudentComparison = {
            show(studentId) {
                const student = DataManager.getStudentById(studentId);
                if (!student) return;
                
                const panel = document.getElementById('comparisonPanel');
                const content = document.getElementById('comparisonContent');
                
                // Calculate class averages
                const averages = {
                    grade: DataManager.students.reduce((sum, s) => sum + s.grade, 0) / DataManager.students.length,
                    aleksDays: DataManager.students.reduce((sum, s) => sum + s.aleksDays, 0) / DataManager.students.length,
                    aleksTopics: DataManager.students.reduce((sum, s) => sum + s.aleksTopics, 0) / DataManager.students.length,
                    thinkTankVisits: DataManager.students.reduce((sum, s) => sum + s.thinkTankVisits, 0) / DataManager.students.length,
                    wellness: DataManager.students.reduce((sum, s) => sum + s.wellness, 0) / DataManager.students.length
                };
                
                content.innerHTML = `
                    <h4>Comparing ${student.fullName} to Class Average</h4>
                    ${this.createComparisonBar('Grade', student.grade, averages.grade, 100, '%')}
                    ${this.createComparisonBar('ALEKS Topics', student.aleksTopics, averages.aleksTopics, 40, '')}
                    ${this.createComparisonBar('Think Tank Visits', student.thinkTankVisits, averages.thinkTankVisits, 10, '')}
                    ${this.createComparisonBar('Wellness Score', student.wellness, averages.wellness, 100, '')}
                    ${this.createComparisonBar('Days Since ALEKS', student.aleksDays, averages.aleksDays, 14, ' days', true)}
                `;
                
                panel.style.display = 'block';
            },
            
            createComparisonBar(label, studentValue, avgValue, maxValue, unit, inverse = false) {
                const studentPercent = (studentValue / maxValue) * 100;
                const avgPercent = (avgValue / maxValue) * 100;
                
                return `
                    <div class="comparison-metric">
                        <div style="width: 150px;">${label}:</div>
                        <div class="comparison-bar">
                            <div class="comparison-fill" style="width: ${avgPercent}%; background: #3498db;"></div>
                            <div class="comparison-fill student" style="width: ${studentPercent}%;"></div>
                        </div>
                        <div style="width: 100px; text-align: right;">
                            <span style="color: #e74c3c;">${Math.round(studentValue)}${unit}</span> /
                            <span style="color: #3498db;">${Math.round(avgValue)}${unit}</span>
                        </div>
                    </div>
                `;
            }
        };

        // === NEW FEATURE: REPORTS ===
        const Reports = {
            generateReport() {
                const reportType = prompt('Report type:\n1. Individual Student\n2. At-Risk Students\n3. Full Class Report\n\nEnter number:');
                
                switch(reportType) {
                    case '1':
                        this.generateIndividualReport();
                        break;
                    case '2':
                        this.generateAtRiskReport();
                        break;
                    case '3':
                        this.generateClassReport();
                        break;
                }
            },
            
            generateIndividualReport() {
                const studentId = prompt('Enter student ID:');
                const student = DataManager.getStudentById(studentId);
                if (!student) {
                    alert('Student not found');
                    return;
                }
                
                const report = `
                    <div style="font-family: Arial; max-width: 800px; margin: 0 auto;">
                        <h1 style="text-align: center;">Student Report</h1>
                        <h2>${student.fullName}</h2>
                        <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                        
                        <h3>Academic Performance</h3>
                        <ul>
                            <li>Current Grade: ${student.grade}%</li>
                            <li>ALEKS Topics Completed: ${student.aleksTopics}</li>
                            <li>Days Since Last ALEKS Login: ${student.aleksDays}</li>
                        </ul>
                        
                        <h3>Support Utilization</h3>
                        <ul>
                            <li>Think Tank Visits: ${student.thinkTankVisits}</li>
                            <li>Wellness Score: ${student.wellness}/100</li>
                            <li>Status: ${student.status}</li>
                        </ul>
                        
                        <h3>Mental Health Indicators</h3>
                        <ul>
                            <li>Stress Level: ${student.stress}/10</li>
                            <li>Confidence Level: ${student.confidence}/10</li>
                        </ul>
                        
                        <h3>Recent Survey Responses</h3>
                        <p><em>Stress:</em> "${student.stressQuote}"</p>
                        <p><em>Confidence:</em> "${student.confidenceQuote}"</p>
                        
                        <h3>Recommendations</h3>
                        <p>${this.getRecommendations(student)}</p>
                    </div>
                `;
                
                const printWindow = window.open('', '', 'width=800,height=600');
                printWindow.document.write(report);
                printWindow.document.close();
                printWindow.print();
            },
            
            generateAtRiskReport() {
                const atRiskStudents = DataManager.students.filter(s => s.status === 'red' || s.status === 'yellow');
                
                const report = `
                    <div style="font-family: Arial; max-width: 800px; margin: 0 auto;">
                        <h1 style="text-align: center;">At-Risk Students Report</h1>
                        <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                        <p><strong>Total At-Risk:</strong> ${atRiskStudents.length}</p>
                        
                        <h2>Critical (Red Status)</h2>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f0f0f0;">
                                    <th style="border: 1px solid #ddd; padding: 8px;">Name</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Grade</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Days Since ALEKS</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Wellness</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${atRiskStudents.filter(s => s.status === 'red').map(s => `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${s.fullName}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${s.grade}%</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${s.aleksDays}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${s.wellness}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                const printWindow = window.open('', '', 'width=800,height=600');
                printWindow.document.write(report);
                printWindow.document.close();
                printWindow.print();
            },
            
            generateClassReport() {
                alert('Full class report generation - would create comprehensive PDF');
            },
            
            getRecommendations(student) {
                const recommendations = [];
                
                if (student.grade < 70) {
                    recommendations.push('Schedule immediate academic intervention');
                }
                if (student.aleksDays > 5) {
                    recommendations.push('Follow up on ALEKS engagement');
                }
                if (student.stress > 7) {
                    recommendations.push('Refer to counseling services');
                }
                if (student.thinkTankVisits === 0) {
                    recommendations.push('Encourage Think Tank utilization');
                }
                
                return recommendations.length > 0 ? recommendations.join('; ') : 'Continue current support strategies';
            }
        };

        // === NEW FEATURE: DASHBOARD CUSTOMIZATION ===
        const DashboardCustomizer = {
            widgets: {
                alerts: { name: 'Alerts Panel', enabled: true },
                comparison: { name: 'Student Comparison', enabled: false },
                predictive: { name: 'Predictive Analytics', enabled: false },
                timeline: { name: 'Timeline', enabled: true }
            },
            
            toggle() {
                const content = `
                    <div class="modal" id="customizeModal" style="display: block;">
                        <div class="modal-content" style="max-width: 500px;">
                            <button class="modal-close" onclick="DashboardCustomizer.close()">×</button>
                            <h2>Customize Dashboard</h2>
                            <p>Select which widgets to display:</p>
                            ${Object.entries(this.widgets).map(([key, widget]) => `
                                <div class="widget-toggle">
                                    <input type="checkbox" id="widget_${key}" ${widget.enabled ? 'checked' : ''} 
                                           onchange="DashboardCustomizer.toggleWidget('${key}')">
                                    <label for="widget_${key}">${widget.name}</label>
                                </div>
                            `).join('')}
                            <button class="filter-button filter-active" onclick="DashboardCustomizer.save()" style="margin-top: 20px;">
                                Save Preferences
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', content);
            },
            
            close() {
                const modal = document.getElementById('customizeModal');
                if (modal) modal.remove();
            },
            
            toggleWidget(key) {
                this.widgets[key].enabled = !this.widgets[key].enabled;
            },
            
            save() {
                localStorage.setItem('dashboardWidgets', JSON.stringify(this.widgets));
                this.applySettings();
                this.close();
            },
            
            load() {
                const saved = localStorage.getItem('dashboardWidgets');
                if (saved) {
                    this.widgets = JSON.parse(saved);
                    this.applySettings();
                }
            },
            
            applySettings() {
                document.getElementById('alertsPanel').style.display = this.widgets.alerts.enabled ? 'block' : 'none';
                document.getElementById('comparisonPanel').style.display = this.widgets.comparison.enabled ? 'block' : 'none';
                document.getElementById('predictiveChart').style.display = this.widgets.predictive.enabled ? 'block' : 'none';
                
                if (this.widgets.predictive.enabled) {
                    PredictiveAnalytics.createPredictiveChart();
                }
            }
        };

        // === ENHANCE EXISTING STUDENT MANAGER ===
        const enhancedStudentManager = {
            ...StudentManager,
            
            display() {
                const container = document.getElementById('studentContainer');
                const filteredStudents = this.getFilteredStudents();

                if (this.currentView === 'list') {
                    container.innerHTML = filteredStudents.map(student => {
                        const concerns = this.getConcerns(student);
                        const prediction = PredictiveAnalytics.predictStatusChange(student);
                        const predictionBadge = prediction && prediction.confidence > 70 ? 
                            `<span class="prediction-badge ${prediction.prediction === 'red' ? 'warning' : ''}">
                                ⚡ Risk: ${prediction.prediction}
                            </span>` : '';
                        
                        return `
                            <div class="student-item student-${student.status} ${BulkActions.selectionMode ? 'selectable' : ''}" 
                                 onclick="${BulkActions.selectionMode ? `BulkActions.toggleStudentSelection('${student.id}')` : `StudentProfile.show('${student.id}')`}">
                                ${BulkActions.selectionMode ? `<input type="checkbox" class="student-checkbox" ${BulkActions.selectedStudents.has(student.id) ? 'checked' : ''}>` : ''}
                                <div class="student-status">${student.statusEmoji}</div>
                                <div class="student-info">
                                    <div class="student-name">
                                        ${student.fullName}
                                        ${predictionBadge}
                                    </div>
                                    <div class="student-details">
                                        ${concerns.length > 0 ? concerns.join(' • ') : 'All indicators positive'}
                                    </div>
                                </div>
                                <div class="student-score" style="color: ${this.getStatusColor(student.status)}">
                                    ${student.wellness}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = `
                        <div class="student-grid">
                            ${filteredStudents.map(student => `
                                <div class="student-card student-${student.status}" onclick="StudentProfile.show('${student.id}')">
                                    <div class="student-status" style="font-size:2em;">${student.statusEmoji}</div>
                                    <div class="student-name" style="margin: 8px 0 4px 0; font-weight:bold;">${student.fullName}</div>
                                    <div style="color:#7f8c8d; font-size:0.95em; margin-bottom:6px;">${student.grade}% • ${student.wellness}/100</div>
                                    <div class="student-score" style="font-size:1.3em; color:${this.getStatusColor(student.status)}">${student.type.charAt(0).toUpperCase() + student.type.slice(1)}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }
        };

        Object.assign(StudentManager, enhancedStudentManager);

        // === ENHANCE STUDENT PROFILE ===
        const enhancedStudentProfile = {
            ...StudentProfile,
            
            show(studentId) {
                StudentProfile.__proto__.show.call(this, studentId);
                
                setTimeout(() => {
                    StudentComparison.show(studentId);
                }, 100);
            }
        };

        Object.assign(StudentProfile, enhancedStudentProfile);

        // === ENHANCED DASHBOARD INITIALIZATION ===
        const enhancedDashboard = {
            ...Dashboard,
            
            init() {
                Dashboard.__proto__.init.call(this);
                
                DashboardCustomizer.load();
                AlertsSystem.checkAlerts();
                
                setInterval(() => {
                    AlertsSystem.checkAlerts();
                }, 60000);
            },
            
            refresh() {
                Dashboard.__proto__.refresh.call(this);
                
                AlertsSystem.checkAlerts();
                if (DashboardCustomizer.widgets.predictive.enabled) {
                    PredictiveAnalytics.createPredictiveChart();
                }
            }
        };

        Object.assign(Dashboard, enhancedDashboard);

        // === INITIALIZE ENHANCED DASHBOARD ===
        document.addEventListener('DOMContentLoaded', () => {
            enhancedDashboard.init();
        });
    </script>
</body>
</html>
